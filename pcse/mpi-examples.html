<html>
<head>
<link href="ihpsc.css" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

  <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>

  <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  <script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {inlineMath: [['$','$']]}
  });
  MathJax.Hub.Config({
    TeX: { equationNumbers: { autoNumber: "AMS" } }
  });
  </script>

  <link rel="stylesheet"
      href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/styles/default.min.css">
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>
</head>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="http://ccrs.cac.cornell.edu:8080/client.0.1.js"></script>
<style>
</style>

<script type="application/javascript">
let fileRoot      = "hello";
let fileName      = fileRoot + ".c";
let compileCmd    = "mpicc " + fileName + " -o " + fileRoot;
let runCmd        = "mpirun --oversubscribe -np 8 " + fileRoot;
let compileRunCmd = [compileCmd, runCmd].join(" && ");

async function afterExecute(results) {
  document.getElementById('stdoutPre').textContent = results.stdout;
  document.getElementById('stderrPre').textContent = results.stderr;
}

async function initialize() {
  let editor = await MonacoEditorFileSource.create("editorDiv");
  editor.setTextFromFile("mpiHello.c");

  let job = await Job.create(JobType.MPI);
  let command = new CommandWithFiles(job, compileRunCmd);
  command.addFileSource(editor, fileName);
  let trigger = new ButtonTrigger(command, afterExecute, "executeBtn");

  document.getElementById("executeBtn").disabled = false;
}

initialize();
</script>

<div class="container">
  <div class="row">
    <div class="col-12">
      <div class="pagehead">
        <h1>MPI Examples</h1>
        <h5>Experimental html version of downloadable textbook, see http://www.tacc.utexas.edu/~eijkhout/istc/istc.html</h5>
      </div>
    </div>
  </div>
  <div>


\[
\newcommand\inv{^{-1}}\newcommand\invt{^{-t}}
\newcommand\bbP{\mathbb{P}}
\newcommand\bbR{\mathbb{R}}
\newcommand\defined{
  \mathrel{\lower 5pt \hbox{${\equiv\atop\mathrm{\scriptstyle D}}$}}}
\]


16.1 : <a href="mpi-examples.html#Bandwidthandhalfbandwidth">Bandwidth and halfbandwidth</a><br>
<a href="index.html">Back to Table of Contents</a>
<h1>16 MPI Examples</h1>
<!-- TranslatingLineGenerator file ['file'] -->
</p>

<h2><a id="Bandwidthandhalfbandwidth">16.1</a> Bandwidth and halfbandwidth</h2>
<p name=crumbs>
crumb trail:  > <a href="mpi-examples.html">mpi-examples</a> > <a href="mpi-examples.html#Bandwidthandhalfbandwidth">Bandwidth and halfbandwidth</a>
</p>
<p name="switchToTextMode">

Bandwidth is the quantity that measures the number of bytes per second that
can go through a connection.
This definition seems straightforward, but commes with many footnotes.
<!-- environment: itemize start embedded generator -->
</p>
<!-- environment block purpose: [[ environment=itemize ]] -->
<itemize>
<ul>
<!-- TranslatingLineGenerator itemize ['itemize'] -->
<li>
The size of the message used matters, since there is a 
<i>latency</i>
  cost to merely starting the message. Often, the bandwidth number quoted
  is an asymptotic figure, hard to achieve in practice.
<li>
If a certain bandwidth figure is attained between a pair of processes,
  will two pairs, sending simultaneously, reach the same number?
<li>
Does the bandwidth depend on the choice of processes to measure?
<li>
And combinations of these considerations.
</ul>
</itemize>
<!-- environment: itemize end embedded generator -->
<p name="switchToTextMode">

A useful measure comes from asking what bandwdith is achievable if all processes
are either sending or receiving.
As a further refinement, we ask what the least favorable choice is
for the communicating pairs:
<!-- environment: quote start embedded generator -->
</p>
<!-- environment block purpose: [[ environment=quote ]] -->
<quote>

<p name="quote">
<!-- TranslatingLineGenerator quote ['quote'] -->
  Halfbandwidth is defined as the minimum total bandwidth,
  over all possible choices of splitting the processes into
  a sending and receiving half.
</p name="quote">
</quote>
<!-- environment: quote end embedded generator -->
<p name="switchToTextMode">

<!-- environment: figure start embedded generator -->
</p>
<!-- environment block purpose: [[ environment=figure ]] -->
<figure>
<float mode=figure>
<!-- TranslatingLineGenerator figure ['figure'] -->
<img src="graphics/hbwprocs-intra.png" width=800></img>
<img src="graphics/hbwprocs-inter.png" width=800></img>
<p name="caption">
FIGURE 16.1: Intra and inter schemes for bandwidth
</p>

</float>
</figure>
<!-- environment: figure end embedded generator -->
<p name="switchToTextMode">

Figure~
16.1
 illustrates the `intra' (left)
and `inter' (right) scheme for letting all processes
communicate in pairs.
With intra-communication, the messages do not rely on the network
so we expect to measure high bandwidth.
With inter-communication, all messages go through the network
and we expect to measure a lower number.
</p>

<p name="switchToTextMode">
However, there are more issues to explore,
which we will now do.
</p>

<p name="switchToTextMode">
First of all we need to find pairs of processes.
Consecutive pairs:
<div class="card">
  <div class="card-header" id="headingOne">
    <h5 class="mb-0">
      <button class="btn btn-link" data-toggle="collapse" data-target="#procpairclose" aria-expanded="false" aria-controls="procpairclose">
        C++ Code: procpairclose
      </button>
    </h5>
  </div>
  <div id="procpairclose" class="collapse">
  <pre>
// halfbandwidth.cxx
int sender = procid - procid%2, receiver = sender+1;
</pre>
</div>
</div>
Pairs that are $P/2$ apart:
<div class="card">
  <div class="card-header" id="headingOne">
    <h5 class="mb-0">
      <button class="btn btn-link" data-toggle="collapse" data-target="#procpairspread" aria-expanded="false" aria-controls="procpairspread">
        C++ Code: procpairspread
      </button>
    </h5>
  </div>
  <div id="procpairspread" class="collapse">
  <pre>
int sender = procid&lt;halfprocs ? procid : procid-halfprocs,
  receiver = sender + halfprocs;
</pre>
</div>
</div>
</p>

<!-- environment: figure start embedded generator -->
<!-- environment block purpose: [[ environment=figure ]] -->
<figure>
<float mode=figure>
<!-- TranslatingLineGenerator figure ['figure'] -->
<p name="switchToTextMode">
  
<img src="plots/hbw-intra.jpg" width=800></img>
<!-- environment: tikzpicture start embedded generator -->
</p>
<!-- environment block purpose: [[ environment=tikzpicture ]] -->
<tikzpicture>


</tikzpicture>
<!-- environment: tikzpicture end embedded generator -->
<p name="switchToTextMode">

<img src="plots/hbw-inter.jpg" width=800></img>
<!-- environment: tikzpicture start embedded generator -->
</p>
<!-- environment block purpose: [[ environment=tikzpicture ]] -->
<tikzpicture>


</tikzpicture>
<!-- environment: tikzpicture end embedded generator -->
<p name="caption">
FIGURE 16.2: Time as a function of core count. Left: on node. Right: between nodes.
</p>

</float>
</figure>
<!-- environment: figure end embedded generator -->
<p name="switchToTextMode">

The halfbandwidth is measured as the total number of bytes sent
divided by the total time.
Both numbers are measured outside a repeat loop that does each
transaction 100&nbsp;times.
<div class="card">
  <div class="card-header" id="headingOne">
    <h5 class="mb-0">
      <button class="btn btn-link" data-toggle="collapse" data-target="#hbwmeasure" aria-expanded="false" aria-controls="hbwmeasure">
        C++ Code: hbwmeasure
      </button>
    </h5>
  </div>
  <div id="hbwmeasure" class="collapse">
  <pre>
auto duration = myclock::now()-start_time;
auto microsec_duration = std::chrono::duration_cast&lt;std::chrono::microseconds&gt;(duration);
int total_ping_count;
MPI_Allreduce(&pingcount,&total_ping_count,1,MPI_INT,MPI_SUM,comm);
long bytes = buffersize * sizeof(double) * total_ping_count;
float fsec = microsec_duration.count() * 1.e-6,
  halfbandwidth = bytes / fsec;
</pre>
</div>
</div>
</p>

<p name="switchToTextMode">
In the left graph of figure&nbsp;
16.2
 we see that the time
for $P/2$ simultaneous pingpongs stays fairly constant.
This reflects the fact that, on node, the ping pong operations are
data copies, which proceed simultaneously.
Thus, the time is independent of the number of cores that are moving data.
The exception is the final data point: with all cores active we take up
more than the available bandwidth on the node.
</p>

<p name="switchToTextMode">
In the right graph, each pingpong is inter-node, going through the network.
Here we see the runtime go up linearly with the number of pingpongs,
or somewhat worse than that.
This reflects the fact that network transfers are done sequentially.
(Actually, message can be broken up in packets, as long as they
satisfy MPI message semantics. This does not alter our argument.)
</p>

<!-- environment: comment start embedded generator -->
<!-- environment block purpose: [[ environment=comment ]] -->
<comment>


</comment>
<!-- environment: comment end embedded generator -->
<p name="switchToTextMode">

<!-- environment: comment start embedded generator -->
</p>
<!-- environment block purpose: [[ environment=comment ]] -->
<comment>


</comment>
<!-- environment: comment end embedded generator -->
<p name="switchToTextMode">

<!-- environment: figure start embedded generator -->
</p>
<!-- environment block purpose: [[ environment=figure ]] -->
<figure>
<float mode=figure>
<!-- TranslatingLineGenerator figure ['figure'] -->
<p name="switchToTextMode">
  
<img src="plots/hbw-intra-bw.jpg" width=800></img>
<!-- environment: tikzpicture start embedded generator -->
</p>
<!-- environment block purpose: [[ environment=tikzpicture ]] -->
<tikzpicture>


</tikzpicture>
<!-- environment: tikzpicture end embedded generator -->
<p name="switchToTextMode">

<img src="plots/hbw-inter-bw.jpg" width=800></img>
<!-- environment: tikzpicture start embedded generator -->
</p>
<!-- environment block purpose: [[ environment=tikzpicture ]] -->
<tikzpicture>


</tikzpicture>
<!-- environment: tikzpicture end embedded generator -->
<p name="caption">
FIGURE 16.3: Bandwidth as a function of buffer size. Left: on node. Right: between nodes.
</p>

</float>
</figure>
<!-- environment: figure end embedded generator -->
<p name="switchToTextMode">

Next we explore the influence of the buffer size on performance.
The right graph in figure&nbsp;
16.3
show that inter-node bandwidth is almost independent of the buffer size.
This means that even our smallest buffer is large enough to overcome
any MPI startup cost.
</p>

<p name="switchToTextMode">
On other hand, the left graph shows a more complicated pattern.
Initially, the bandwidth increases, possibly reflecting
the decreasing importance of MPI startup.
For the final data points, however, performance drops again.
This is due to the fact that the data size overflows
cache size, and we are dominated by bandwidth from memory, rather than cache.
</p>

<p name="switchToTextMode">

<!-- environment: comment start embedded generator -->
</p>
<!-- environment block purpose: [[ environment=comment ]] -->
<comment>


</comment>
<!-- environment: comment end embedded generator -->
</div>
<a href="index.html">Back to Table of Contents</a>
