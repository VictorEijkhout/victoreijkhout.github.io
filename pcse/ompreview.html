<html>
<head>
<link href="ihpsc.css" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

  <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>

  <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  <script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {inlineMath: [['$','$']]}
  });
  MathJax.Hub.Config({
    TeX: { equationNumbers: { autoNumber: "AMS" } }
  });
  </script>

  <link rel="stylesheet"
      href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/styles/default.min.css">
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>
</head>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src=https://ccrs.cac.cornell.edu:8443/client.0.2.js></script>
<script id="script">
class Example {
  constructor(buttonID, editorID, outputID, sourceFile, fileName, commandStr) {
    this.buttonID = buttonID;
    this.editorID = editorID;
    this.outputID = outputID;
    this.sourceFile = sourceFile;
    this.fileName = fileName;
    this.commandStr = commandStr;
  }
    
  async display(results, object) {
    if (results.stdout.length > 0)
      document.getElementById(object.outputID).textContent = results.stdout;
    else
      document.getElementById(object.outputID).textContent = results.stderr;
  }

  async initialize() {
    this.editor = await MonacoEditorFileSource.create(this.editorID);
    this.editor.setTextFromFile(this.sourceFile);
    this.job = await Job.create(JobType.MPI);
    this.command = new CommandWithFiles(this.job, this.commandStr);
    this.command.addFileSource(this.editor, this.fileName);
    this.trigger = new ButtonTrigger(this.command, this.display, this.buttonID, this);
    document.getElementById(this.buttonID).disabled = false;
  }
}
</script>
<style></style>

<div class="container">
  <div class="row">
    <div class="col-12">
      <div class="pagehead">
        <h1>OpenMP Review</h1>
        <h5>Experimental html version of downloadable textbook, see http://www.tacc.utexas.edu/~eijkhout/istc/istc.html</h5>
      </div>
    </div>
  </div>
  <div>


\[
\newcommand\inv{^{-1}}\newcommand\invt{^{-t}}
\newcommand\bbP{\mathbb{P}}
\newcommand\bbR{\mathbb{R}}
\newcommand\defined{
  \mathrel{\lower 5pt \hbox{${\equiv\atop\mathrm{\scriptstyle D}}$}}}
\]


30.1 : <a href="ompreview.html#Conceptsreview">Concepts review</a><br>
30.1.1 : <a href="ompreview.html#Basicconcepts">Basic concepts</a><br>
30.1.2 : <a href="ompreview.html#Parallelregions">Parallel regions</a><br>
30.1.3 : <a href="ompreview.html#Worksharing">Work sharing</a><br>
30.1.4 : <a href="ompreview.html#Datascope">Data scope</a><br>
30.1.5 : <a href="ompreview.html#Synchronization">Synchronization</a><br>
30.1.6 : <a href="ompreview.html#Tasks">Tasks</a><br>
30.2 : <a href="ompreview.html#Reviewquestions">Review questions</a><br>
30.2.1 : <a href="ompreview.html#Directives">Directives</a><br>
30.2.2 : <a href="ompreview.html#Parallelism">Parallelism</a><br>
30.2.3 : <a href="ompreview.html#Dataandsynchronization">Data and synchronization</a><br>
30.2.3.1 : <a href="ompreview.html#"></a><br>
30.2.3.2 : <a href="ompreview.html#"></a><br>
30.2.3.3 : <a href="ompreview.html#"></a><br>
30.2.4 : <a href="ompreview.html#Reductions">Reductions</a><br>
30.2.4.1 : <a href="ompreview.html#"></a><br>
30.2.4.2 : <a href="ompreview.html#"></a><br>
30.2.5 : <a href="ompreview.html#Barriers">Barriers</a><br>
30.2.6 : <a href="ompreview.html#Datascope">Data scope</a><br>
30.2.7 : <a href="ompreview.html#Tasks">Tasks</a><br>
30.2.8 : <a href="ompreview.html#Scheduling">Scheduling</a><br>
<a href="index.html">Back to Table of Contents</a>
<h1>30 OpenMP Review</h1>
<!-- TranslatingLineGenerator file ['file'] -->
<p name="switchToTextMode">

<h2><a id="Conceptsreview">30.1</a> Concepts review</h2>
<p name=crumbs>
crumb trail:  > <a href="ompreview.html">ompreview</a> > <a href="ompreview.html#Conceptsreview">Concepts review</a>
</p>
</p>

<!-- environment: multicols start embedded generator -->
<!-- environment block purpose: [[ environment=multicols ]] -->
<multicols>

<p name="multicols">
<!-- TranslatingLineGenerator multicols ['multicols'] -->
<h3><a id="Basicconcepts">30.1.1</a> Basic concepts</h3>
<p name=crumbs>
crumb trail:  > <a href="ompreview.html">ompreview</a> > <a href="ompreview.html#Conceptsreview">Concepts review</a> > <a href="ompreview.html#Basicconcepts">Basic concepts</a>
</p>
</p>

<!-- environment: itemize start embedded generator -->
<!-- environment block purpose: [[ environment=itemize ]] -->
<itemize>
<ul>
<!-- TranslatingLineGenerator itemize ['itemize'] -->
<li>
process / thread / thread team
<li>
threads / cores / tasks
<li>
directives / library functions / environment variables
</ul>
</itemize>
<!-- environment: itemize end embedded generator -->
<p name="switchToTextMode">

<h3><a id="Parallelregions">30.1.2</a> Parallel regions</h3>
<p name=crumbs>
crumb trail:  > <a href="ompreview.html">ompreview</a> > <a href="ompreview.html#Conceptsreview">Concepts review</a> > <a href="ompreview.html#Parallelregions">Parallel regions</a>
</p>
</p>

<p name="switchToTextMode">
execution by a team
</p>

<h3><a id="Worksharing">30.1.3</a> Work sharing</h3>
<p name=crumbs>
crumb trail:  > <a href="ompreview.html">ompreview</a> > <a href="ompreview.html#Conceptsreview">Concepts review</a> > <a href="ompreview.html#Worksharing">Work sharing</a>
</p>
<p name="switchToTextMode">

<!-- environment: itemize start embedded generator -->
</p>
<!-- environment block purpose: [[ environment=itemize ]] -->
<itemize>
<ul>
<!-- TranslatingLineGenerator itemize ['itemize'] -->
<li>
loop / sections / single / workshare
<li>
implied barrier
<li>
loop scheduling, reduction
<li>
sections
<li>
single vs master
<li>
(F) workshare
</ul>
</itemize>
<!-- environment: itemize end embedded generator -->
<p name="switchToTextMode">

<h3><a id="Datascope">30.1.4</a> Data scope</h3>
<p name=crumbs>
crumb trail:  > <a href="ompreview.html">ompreview</a> > <a href="ompreview.html#Conceptsreview">Concepts review</a> > <a href="ompreview.html#Datascope">Data scope</a>
</p>
</p>

<!-- environment: itemize start embedded generator -->
<!-- environment block purpose: [[ environment=itemize ]] -->
<itemize>
<ul>
<!-- TranslatingLineGenerator itemize ['itemize'] -->
<li>
shared vs private, C vs F
<li>
loop variables and reduction variables
<li>
default declaration
<li>
firstprivate, lastprivate
</ul>
</itemize>
<!-- environment: itemize end embedded generator -->
<p name="switchToTextMode">

<h3><a id="Synchronization">30.1.5</a> Synchronization</h3>
<p name=crumbs>
crumb trail:  > <a href="ompreview.html">ompreview</a> > <a href="ompreview.html#Conceptsreview">Concepts review</a> > <a href="ompreview.html#Synchronization">Synchronization</a>
</p>
</p>

<!-- environment: itemize start embedded generator -->
<!-- environment block purpose: [[ environment=itemize ]] -->
<itemize>
<ul>
<!-- TranslatingLineGenerator itemize ['itemize'] -->
<li>
barriers, implied and explicit
<li>
nowait
<li>
critical sections
<li>
locks, difference with critical
</ul>
</itemize>
<!-- environment: itemize end embedded generator -->
<p name="switchToTextMode">

<h3><a id="Tasks">30.1.6</a> Tasks</h3>
<p name=crumbs>
crumb trail:  > <a href="ompreview.html">ompreview</a> > <a href="ompreview.html#Conceptsreview">Concepts review</a> > <a href="ompreview.html#Tasks">Tasks</a>
</p>
</p>

<!-- environment: itemize start embedded generator -->
<!-- environment block purpose: [[ environment=itemize ]] -->
<itemize>
<ul>
<!-- TranslatingLineGenerator itemize ['itemize'] -->
<li>
generation vs execution
<li>
dependencies
</ul>
</itemize>
<!-- environment: itemize end embedded generator -->
<p name="switchToTextMode">

</p>

</multicols>
<!-- environment: multicols end embedded generator -->
<p name="switchToTextMode">

</p>

<h2><a id="Reviewquestions">30.2</a> Review questions</h2>
<p name=crumbs>
crumb trail:  > <a href="ompreview.html">ompreview</a> > <a href="ompreview.html#Reviewquestions">Review questions</a>
</p>
<p name="switchToTextMode">

<h3><a id="Directives">30.2.1</a> Directives</h3>
<p name=crumbs>
crumb trail:  > <a href="ompreview.html">ompreview</a> > <a href="ompreview.html#Reviewquestions">Review questions</a> > <a href="ompreview.html#Directives">Directives</a>
</p>
</p>

<p name="switchToTextMode">
What do the following program output?
</p>

<!-- environment: multicols start embedded generator -->
<!-- environment block purpose: [[ environment=multicols ]] -->
<multicols>

<p name="multicols">
<!-- TranslatingLineGenerator multicols ['multicols'] -->
\small
<!-- environment: lstlisting start embedded generator -->
</p>
<!-- environment block purpose: [[ environment=lstlisting ]] -->
<lstlisting>
<pre>
int main() {
  printf("procs %d\n",
    omp_get_num_procs());
  printf("threads %d\n",
    omp_get_num_threads());
  printf("num %d\n",
    omp_get_thread_num());
  return 0;
}
</pre>
</lstlisting>
<!-- environment: lstlisting end embedded generator -->
<p name="switchToTextMode">

</p>

<!-- environment: lstlisting start embedded generator -->
<!-- environment block purpose: [[ environment=lstlisting ]] -->
<lstlisting>
<pre>
int main() {
#pragma omp parallel
  {
  printf("procs %d\n",
    omp_get_num_procs());
  printf("threads %d\n",
    omp_get_num_threads());
  printf("num %d\n",
    omp_get_thread_num());
  }
  return 0;
}
</pre>
</lstlisting>
<!-- environment: lstlisting end embedded generator -->
</multicols>
<!-- environment: multicols end embedded generator -->
<p name="switchToTextMode">

<!-- environment: multicols start embedded generator -->
</p>
<!-- environment block purpose: [[ environment=multicols ]] -->
<multicols>

<p name="multicols">
<!-- TranslatingLineGenerator multicols ['multicols'] -->
\small
<!-- environment: lstlisting start embedded generator -->
</p>
<!-- environment block purpose: [[ environment=lstlisting ]] -->
<lstlisting>
<pre>
Program main
  use omp_lib
  print *,"Procs:",&
    omp_get_num_procs()
  print *,"Threads:",&
    omp_get_num_threads()
  print *,"Num:",&
    omp_get_thread_num()
End Program
</pre>
</lstlisting>
<!-- environment: lstlisting end embedded generator -->
<p name="switchToTextMode">

</p>

<!-- environment: lstlisting start embedded generator -->
<!-- environment block purpose: [[ environment=lstlisting ]] -->
<lstlisting>
<pre>
Program main
  use omp_lib
!$OMP parallel
  print *,"Procs:",&
    omp_get_num_procs()
  print *,"Threads:",&
    omp_get_num_threads()
  print *,"Num:",&
    omp_get_thread_num()
!$OMP end parallel
End Program
</pre>
</lstlisting>
<!-- environment: lstlisting end embedded generator -->
</multicols>
<!-- environment: multicols end embedded generator -->
<p name="switchToTextMode">

</p>

<p name="switchToTextMode">
\vfill\pagebreak
</p>

<h3><a id="Parallelism">30.2.2</a> Parallelism</h3>
<p name=crumbs>
crumb trail:  > <a href="ompreview.html">ompreview</a> > <a href="ompreview.html#Reviewquestions">Review questions</a> > <a href="ompreview.html#Parallelism">Parallelism</a>
</p>
<p name="switchToTextMode">

Can the following loops be parallelized? If so, how?
(Assume that all arrays are already filled in,
and that there are no out-of-bounds errors.)
<!-- environment: multicols start embedded generator -->
</p>
<!-- environment block purpose: [[ environment=multicols ]] -->
<multicols>

<p name="multicols">
<!-- TranslatingLineGenerator multicols ['multicols'] -->
\small
<!-- environment: lstlisting start embedded generator -->
</p>
<!-- environment block purpose: [[ environment=lstlisting ]] -->
<lstlisting>
<pre>
// variant #1
for (i=0; i&lt;N; i++) {
  x[i] = a[i]+b[i+1];
  a[i] = 2*x[i] + c[i+1];
}
</pre>
</lstlisting>
<!-- environment: lstlisting end embedded generator -->
<p name="switchToTextMode">

<!-- environment: lstlisting start embedded generator -->
</p>
<!-- environment block purpose: [[ environment=lstlisting ]] -->
<lstlisting>
<pre>
// variant #2
for (i=0; i&lt;N; i++) {
  x[i] = a[i]+b[i+1];
  a[i] = 2*x[i+1] + c[i+1];
}
</pre>
</lstlisting>
<!-- environment: lstlisting end embedded generator -->
<p name="switchToTextMode">

</p>

<!-- environment: lstlisting start embedded generator -->
<!-- environment block purpose: [[ environment=lstlisting ]] -->
<lstlisting>
<pre>
// variant #3
for (i=1; i&lt;N; i++) {
  x[i] = a[i]+b[i+1];
  a[i] = 2*x[i-1] + c[i+1];
}
</pre>
</lstlisting>
<!-- environment: lstlisting end embedded generator -->
<p name="switchToTextMode">

<!-- environment: lstlisting start embedded generator -->
</p>
<!-- environment block purpose: [[ environment=lstlisting ]] -->
<lstlisting>
<pre>
// variant #4
for (i=1; i&lt;N; i++) {
  x[i] = a[i]+b[i+1];
  a[i+1] = 2*x[i-1] + c[i+1];
}
</pre>
</lstlisting>
<!-- environment: lstlisting end embedded generator -->
</multicols>
<!-- environment: multicols end embedded generator -->
<p name="switchToTextMode">

<!-- environment: multicols start embedded generator -->
</p>
<!-- environment block purpose: [[ environment=multicols ]] -->
<multicols>

<p name="multicols">
<!-- TranslatingLineGenerator multicols ['multicols'] -->
\small
<!-- environment: lstlisting start embedded generator -->
</p>
<!-- environment block purpose: [[ environment=lstlisting ]] -->
<lstlisting>
<pre>
! variant #1
do i=1,N
  x(i) = a(i)+b(i+1)
  a(i) = 2*x(i) + c(i+1)
end do
</pre>
</lstlisting>
<!-- environment: lstlisting end embedded generator -->
<p name="switchToTextMode">

<!-- environment: lstlisting start embedded generator -->
</p>
<!-- environment block purpose: [[ environment=lstlisting ]] -->
<lstlisting>
<pre>
! variant #2
do i=1,N
  x(i) = a(i)+b(i+1)
  a(i) = 2*x(i+1) + c(i+1)
end do
</pre>
</lstlisting>
<!-- environment: lstlisting end embedded generator -->
<p name="switchToTextMode">

</p>

<!-- environment: lstlisting start embedded generator -->
<!-- environment block purpose: [[ environment=lstlisting ]] -->
<lstlisting>
<pre>
! variant #3
do i=2,N
  x(i) = a(i)+b(i+1)
  a(i) = 2*x(i-1) + c(i+1)
end do
</pre>
</lstlisting>
<!-- environment: lstlisting end embedded generator -->
<p name="switchToTextMode">

<!-- environment: lstlisting start embedded generator -->
</p>
<!-- environment block purpose: [[ environment=lstlisting ]] -->
<lstlisting>
<pre>
! variant #3
do i=2,N
  x(i) = a(i)+b(i+1)
  a(i+1) = 2*x(i-1) + c(i+1)
end do
</pre>
</lstlisting>
<!-- environment: lstlisting end embedded generator -->
</multicols>
<!-- environment: multicols end embedded generator -->
<p name="switchToTextMode">

\vfill\pagebreak
</p>

<h3><a id="Dataandsynchronization">30.2.3</a> Data and synchronization</h3>
<p name=crumbs>
crumb trail:  > <a href="ompreview.html">ompreview</a> > <a href="ompreview.html#Reviewquestions">Review questions</a> > <a href="ompreview.html#Dataandsynchronization">Data and synchronization</a>
</p>
<p name="switchToTextMode">

<h4><a id="">30.2.3.1</a> </h4>
<p name=crumbs>
crumb trail:  > <a href="ompreview.html">ompreview</a> > <a href="ompreview.html#Reviewquestions">Review questions</a> > <a href="ompreview.html#Dataandsynchronization">Data and synchronization</a> > <a href="ompreview.html#"></a>
</p>
</p>

<p name="switchToTextMode">
What is the output of the following fragments? Assume that there are four threads.
</p>

<!-- environment: multicols start embedded generator -->
<!-- environment block purpose: [[ environment=multicols ]] -->
<multicols>

<p name="multicols">
<!-- TranslatingLineGenerator multicols ['multicols'] -->
\small
<!-- environment: lstlisting start embedded generator -->
</p>
<!-- environment block purpose: [[ environment=lstlisting ]] -->
<lstlisting>
<pre>
// variant #1
int nt;
#pragma omp parallel
  {
  nt = omp_get_thread_num();
  printf("thread number: %d\n",nt);
  }
</pre>
</lstlisting>
<!-- environment: lstlisting end embedded generator -->
<p name="switchToTextMode">

<!-- environment: lstlisting start embedded generator -->
</p>
<!-- environment block purpose: [[ environment=lstlisting ]] -->
<lstlisting>
<pre>
// variant #2
int nt;
#pragma omp parallel private(nt)
  {
  nt = omp_get_thread_num();
  printf("thread number: %d\n",nt);
  }
</pre>
</lstlisting>
<!-- environment: lstlisting end embedded generator -->
<p name="switchToTextMode">

<!-- environment: lstlisting start embedded generator -->
</p>
<!-- environment block purpose: [[ environment=lstlisting ]] -->
<lstlisting>
<pre>
// variant #3
int nt;
#pragma omp parallel
  {
#pragma omp single
    {
    nt = omp_get_thread_num();
    printf("thread number: %d\n",nt);
    }
  }
</pre>
</lstlisting>
<!-- environment: lstlisting end embedded generator -->
<p name="switchToTextMode">

</p>

<!-- environment: lstlisting start embedded generator -->
<!-- environment block purpose: [[ environment=lstlisting ]] -->
<lstlisting>
<pre>
// variant #4
int nt;
#pragma omp parallel
  {
#pragma omp master
    {
    nt = omp_get_thread_num();
    printf("thread number: %d\n",nt);
    }
  }
</pre>
</lstlisting>
<!-- environment: lstlisting end embedded generator -->
<p name="switchToTextMode">

<!-- environment: lstlisting start embedded generator -->
</p>
<!-- environment block purpose: [[ environment=lstlisting ]] -->
<lstlisting>
<pre>
// variant #5
int nt;
#pragma omp parallel
  {
#pragma omp critical
    {
    nt = omp_get_thread_num();
    printf("thread number: %d\n",nt);
    }
  }
</pre>
</lstlisting>
<!-- environment: lstlisting end embedded generator -->
</multicols>
<!-- environment: multicols end embedded generator -->
<p name="switchToTextMode">

<!-- environment: multicols start embedded generator -->
</p>
<!-- environment block purpose: [[ environment=multicols ]] -->
<multicols>

<p name="multicols">
<!-- TranslatingLineGenerator multicols ['multicols'] -->
\small
<!-- environment: lstlisting start embedded generator -->
</p>
<!-- environment block purpose: [[ environment=lstlisting ]] -->
<lstlisting>
<pre>
! variant #1
  integer nt
!$OMP parallel
  nt = omp_get_thread_num()
  print *,"thread number:",nt
!$OMP end parallel
</pre>
</lstlisting>
<!-- environment: lstlisting end embedded generator -->
<p name="switchToTextMode">

<!-- environment: lstlisting start embedded generator -->
</p>
<!-- environment block purpose: [[ environment=lstlisting ]] -->
<lstlisting>
<pre>
! variant #2
  integer nt
!$OMP parallel private(nt)
  nt = omp_get_thread_num()
  print *,"thread number:",nt
!$OMP end parallel
</pre>
</lstlisting>
<!-- environment: lstlisting end embedded generator -->
<p name="switchToTextMode">

<!-- environment: lstlisting start embedded generator -->
</p>
<!-- environment block purpose: [[ environment=lstlisting ]] -->
<lstlisting>
<pre>
! variant #3
  integer nt
!$OMP parallel
!$OMP single
    nt = omp_get_thread_num()
    print *,"thread number:",nt
!$OMP end single
!$OMP end parallel
</pre>
</lstlisting>
<!-- environment: lstlisting end embedded generator -->
<p name="switchToTextMode">

</p>

<!-- environment: lstlisting start embedded generator -->
<!-- environment block purpose: [[ environment=lstlisting ]] -->
<lstlisting>
<pre>
! variant #4
  integer nt
!$OMP parallel
!$OMP master
    nt = omp_get_thread_num()
    print *,"thread number:",nt
!$OMP end master
!$OMP end parallel
</pre>
</lstlisting>
<!-- environment: lstlisting end embedded generator -->
<p name="switchToTextMode">

<!-- environment: lstlisting start embedded generator -->
</p>
<!-- environment block purpose: [[ environment=lstlisting ]] -->
<lstlisting>
<pre>
! variant #5
  integer nt
!$OMP parallel
!$OMP critical
    nt = omp_get_thread_num()
    print *,"thread number:",nt
!$OMP end critical
!$OMP end parallel
</pre>
</lstlisting>
<!-- environment: lstlisting end embedded generator -->
</multicols>
<!-- environment: multicols end embedded generator -->
<p name="switchToTextMode">

<h4><a id="">30.2.3.2</a> </h4>
<p name=crumbs>
crumb trail:  > <a href="ompreview.html">ompreview</a> > <a href="ompreview.html#Reviewquestions">Review questions</a> > <a href="ompreview.html#Dataandsynchronization">Data and synchronization</a> > <a href="ompreview.html#"></a>
</p>
</p>

<p name="switchToTextMode">
The following is an attempt to parallelize a serial code.
Assume that all variables and arrays are defined.
What errors and potential problems do you see in this code? How would you fix them?
</p>

<!-- environment: multicols start embedded generator -->
<!-- environment block purpose: [[ environment=multicols ]] -->
<multicols>

<p name="multicols">
<!-- TranslatingLineGenerator multicols ['multicols'] -->
\small
<!-- environment: lstlisting start embedded generator -->
</p>
<!-- environment block purpose: [[ environment=lstlisting ]] -->
<lstlisting>
<pre>
#pragma omp parallel
{
  x = f();
  #pragma omp for
  for (i=0; i&lt;N; i++)
    y[i] = g(x,i);
  z = h(y);
}
</pre>
</lstlisting>
<!-- environment: lstlisting end embedded generator -->
<p name="switchToTextMode">

</p>

<!-- environment: lstlisting start embedded generator -->
<!-- environment block purpose: [[ environment=lstlisting ]] -->
<lstlisting>
<pre>
!$OMP parallel
  x = f()
!$OMP do
  do i=1,N
    y(i) = g(x,i)
  end do
!$OMP end do
  z = h(y)
!$OMP end parallel
</pre>
</lstlisting>
<!-- environment: lstlisting end embedded generator -->
</multicols>
<!-- environment: multicols end embedded generator -->
<p name="switchToTextMode">

<!-- environment: answer start embedded generator -->
</p>
<!-- environment block purpose: [[ environment=answer ]] -->
<answer>


</answer>
<!-- environment: answer end embedded generator -->
<p name="switchToTextMode">

\vfill\pagebreak
</p>

<h4><a id="">30.2.3.3</a> </h4>
<p name=crumbs>
crumb trail:  > <a href="ompreview.html">ompreview</a> > <a href="ompreview.html#Reviewquestions">Review questions</a> > <a href="ompreview.html#Dataandsynchronization">Data and synchronization</a> > <a href="ompreview.html#"></a>
</p>
<p name="switchToTextMode">

Assume two threads. What does the following program output?
</p>

<!-- environment: lstlisting start embedded generator -->
<!-- environment block purpose: [[ environment=lstlisting ]] -->
<lstlisting>
<pre>
int a;
#pragma omp parallel private(a) {
  ...
  a = 0;
  #pragma omp for
  for (int i = 0; i &lt; 10; i++)
  {
    #pragma omp atomic
    a++; }
  #pragma omp single
    printf("a=%e\n",a);
}
</pre>
</lstlisting>
<!-- environment: lstlisting end embedded generator -->
<p name="switchToTextMode">

<h3><a id="Reductions">30.2.4</a> Reductions</h3>
<p name=crumbs>
crumb trail:  > <a href="ompreview.html">ompreview</a> > <a href="ompreview.html#Reviewquestions">Review questions</a> > <a href="ompreview.html#Reductions">Reductions</a>
</p>
</p>

<h4><a id="">30.2.4.1</a> </h4>
<p name=crumbs>
crumb trail:  > <a href="ompreview.html">ompreview</a> > <a href="ompreview.html#Reviewquestions">Review questions</a> > <a href="ompreview.html#Reductions">Reductions</a> > <a href="ompreview.html#"></a>
</p>
<p name="switchToTextMode">

Is the following code correct? Is it efficient? If not, can you improve it?
<!-- environment: verbatim start embedded generator -->
</p>
<!-- environment block purpose: [[ environment=verbatim ]] -->
<verbatim>
<pre>
#pragma omp parallel shared(r)
{
  int x;
  x = f(omp_get_thread_num());
#pragma omp critical
  r += f(x);
}
</pre>
</verbatim>
<!-- environment: verbatim end embedded generator -->
<p name="switchToTextMode">

<h4><a id="">30.2.4.2</a> </h4>
<p name=crumbs>
crumb trail:  > <a href="ompreview.html">ompreview</a> > <a href="ompreview.html#Reviewquestions">Review questions</a> > <a href="ompreview.html#Reductions">Reductions</a> > <a href="ompreview.html#"></a>
</p>
</p>

<p name="switchToTextMode">
Compare two fragments:
<!-- environment: multicols start embedded generator -->
</p>
<!-- environment block purpose: [[ environment=multicols ]] -->
<multicols>

<p name="multicols">
<!-- TranslatingLineGenerator multicols ['multicols'] -->
<!-- environment: lstlisting start embedded generator -->
</p>
<!-- environment block purpose: [[ environment=lstlisting ]] -->
<lstlisting>
<pre>
// variant 1
#pragma omp parallel reduction(+:s)
#pragma omp for
  for (i=0; i&lt;N; i++)
    s += f(i);
</pre>
</lstlisting>
<!-- environment: lstlisting end embedded generator -->
<p name="switchToTextMode">

<!-- environment: lstlisting start embedded generator -->
</p>
<!-- environment block purpose: [[ environment=lstlisting ]] -->
<lstlisting>
<pre>
// variant 2
#pragma omp parallel
#pragma omp for reduction(+:s)
  for (i=0; i&lt;N; i++)
    s += f(i);
</pre>
</lstlisting>
<!-- environment: lstlisting end embedded generator -->
</multicols>
<!-- environment: multicols end embedded generator -->
<p name="switchToTextMode">

<!-- environment: multicols start embedded generator -->
</p>
<!-- environment block purpose: [[ environment=multicols ]] -->
<multicols>

<p name="multicols">
<!-- TranslatingLineGenerator multicols ['multicols'] -->
<!-- environment: lstlisting start embedded generator -->
</p>
<!-- environment block purpose: [[ environment=lstlisting ]] -->
<lstlisting>
<pre>
! variant 1
!$OMP parallel reduction(+:s)
!$OMP do
  do i=1,N
    s += f(i);
  end do
!$OMP end do
!$OMP end parallel
</pre>
</lstlisting>
<!-- environment: lstlisting end embedded generator -->
<p name="switchToTextMode">

<!-- environment: lstlisting start embedded generator -->
</p>
<!-- environment block purpose: [[ environment=lstlisting ]] -->
<lstlisting>
<pre>
! variant 2
!$OMP parallel
!$OMP do reduction(+:s)
  do i=1,N
    s += f(i);
  end do
!$OMP end do
!$OMP end parallel
</pre>
</lstlisting>
<!-- environment: lstlisting end embedded generator -->
</multicols>
<!-- environment: multicols end embedded generator -->
<p name="switchToTextMode">

Do they compute the same thing?
</p>

<p name="switchToTextMode">
\vfill\pagebreak
</p>

<h3><a id="Barriers">30.2.5</a> Barriers</h3>
<p name=crumbs>
crumb trail:  > <a href="ompreview.html">ompreview</a> > <a href="ompreview.html#Reviewquestions">Review questions</a> > <a href="ompreview.html#Barriers">Barriers</a>
</p>
<p name="switchToTextMode">

Are the following two code fragments well defined?
<!-- environment: multicols start embedded generator -->
</p>
<!-- environment block purpose: [[ environment=multicols ]] -->
<multicols>

<p name="multicols">
<!-- TranslatingLineGenerator multicols ['multicols'] -->
<!-- environment: lstlisting start embedded generator -->
</p>
<!-- environment block purpose: [[ environment=lstlisting ]] -->
<lstlisting>
<pre>
#pragma omp parallel
{
#pragma omp for
for (mytid=0; mytid&lt;nthreads; mytid++)
  x[mytid] = some_calculation();
#pragma omp for
for (mytid=0; mytid&lt;nthreads-1; mytid++)
  y[mytid] = x[mytid]+x[mytid+1];
}
</pre>
</lstlisting>
<!-- environment: lstlisting end embedded generator -->
<p name="switchToTextMode">

<!-- environment: lstlisting start embedded generator -->
</p>
<!-- environment block purpose: [[ environment=lstlisting ]] -->
<lstlisting>
<pre>
#pragma omp parallel
{
#pragma omp for
for (mytid=0; mytid&lt;nthreads; mytid++)
  x[mytid] = some_calculation();
#pragma omp for nowait
for (mytid=0; mytid&lt;nthreads-1; mytid++)
  y[mytid] = x[mytid]+x[mytid+1];
}
</pre>
</lstlisting>
<!-- environment: lstlisting end embedded generator -->
</multicols>
<!-- environment: multicols end embedded generator -->
<p name="switchToTextMode">

<h3><a id="Datascope">30.2.6</a> Data scope</h3>
<p name=crumbs>
crumb trail:  > <a href="ompreview.html">ompreview</a> > <a href="ompreview.html#Reviewquestions">Review questions</a> > <a href="ompreview.html#Datascope">Data scope</a>
</p>
</p>

<p name="switchToTextMode">
The following program is supposed to initialize as many
rows of the array as there are threads.
</p>

<!-- environment: multicols start embedded generator -->
<!-- environment block purpose: [[ environment=multicols ]] -->
<multicols>

<p name="multicols">
<!-- TranslatingLineGenerator multicols ['multicols'] -->
\small
<!-- environment: lstlisting start embedded generator -->
</p>
<!-- environment block purpose: [[ environment=lstlisting ]] -->
<lstlisting>
<pre>
int main() {
  int i,icount,iarray[100][100];
  icount = -1;
#pragma omp parallel private(i)
  {
#pragma omp critical
    { icount++; }
    for (i=0; i&lt;100; i++)
      iarray[icount][i] = 1;
  }
  return 0;
}
</pre>
</lstlisting>
<!-- environment: lstlisting end embedded generator -->
<p name="switchToTextMode">

<!-- environment: lstlisting start embedded generator -->
</p>
<!-- environment block purpose: [[ environment=lstlisting ]] -->
<lstlisting>
<pre>
Program main
  integer :: i,icount,iarray(100,100)
  icount = 0
!$OMP parallel private(i)
!$OMP critical
    icount = icount + 1
!$OMP end critical
    do i=1,100
      iarray(icount,i) = 1
    end do
!$OMP end parallel
End program
</pre>
</lstlisting>
<!-- environment: lstlisting end embedded generator -->
</multicols>
<!-- environment: multicols end embedded generator -->
<p name="switchToTextMode">

Describe the behavior of the program, with argumentation,
<!-- environment: itemize start embedded generator -->
</p>
<!-- environment block purpose: [[ environment=itemize ]] -->
<itemize>
<ul>
<!-- TranslatingLineGenerator itemize ['itemize'] -->
<li>
as given;
<li>
if you add a clause 
<tt>private</tt>

<tt>(icount)</tt>

  to the 
<tt>parallel</tt>
 directive;
<li>
if you add a clause 
<tt>firstprivate</tt>

<tt>(icount)</tt>
.
</ul>
</itemize>
<!-- environment: itemize end embedded generator -->
<p name="switchToTextMode">

What do you think of this solution:
<!-- environment: multicols start embedded generator -->
</p>
<!-- environment block purpose: [[ environment=multicols ]] -->
<multicols>

<p name="multicols">
<!-- TranslatingLineGenerator multicols ['multicols'] -->
\small
<!-- environment: lstlisting start embedded generator -->
</p>
<!-- environment block purpose: [[ environment=lstlisting ]] -->
<lstlisting>
<pre>
#pragma omp parallel private(i) shared(icount)
  {
#pragma omp critical
    { icount++;
      for (i=0; i&lt;100; i++)
        iarray[icount][i] = 1;
    }
  }
  return 0;
}
</pre>
</lstlisting>
<!-- environment: lstlisting end embedded generator -->
<p name="switchToTextMode">

</p>

<!-- environment: lstlisting start embedded generator -->
<!-- environment block purpose: [[ environment=lstlisting ]] -->
<lstlisting>
<pre>
!$OMP parallel private(i) shared(icount)
!$OMP critical
    icount = icount+1
    do i=1,100
      iarray(icount,i) = 1
    end do
!$OMP critical
!$OMP end parallel
</pre>
</lstlisting>
<!-- environment: lstlisting end embedded generator -->
</multicols>
<!-- environment: multicols end embedded generator -->
<p name="switchToTextMode">

<h3><a id="Tasks">30.2.7</a> Tasks</h3>
<p name=crumbs>
crumb trail:  > <a href="ompreview.html">ompreview</a> > <a href="ompreview.html#Reviewquestions">Review questions</a> > <a href="ompreview.html#Tasks">Tasks</a>
</p>
</p>

<p name="switchToTextMode">
Fix two things in the following example:
<!-- environment: multicols start embedded generator -->
</p>
<!-- environment block purpose: [[ environment=multicols ]] -->
<multicols>

<p name="multicols">
<!-- TranslatingLineGenerator multicols ['multicols'] -->
\small
<!-- environment: lstlisting start embedded generator -->
</p>
<!-- environment block purpose: [[ environment=lstlisting ]] -->
<lstlisting>
<pre>
#pragma omp parallel
#pragma omp single
{
  int x,y,z;
#pragma omp task
  x = f();
#pragma omp task
  y = g();
#pragma omp task
  z = h();
  printf("sum=%d\n",x+y+z);
}
</pre>
</lstlisting>
<!-- environment: lstlisting end embedded generator -->
<p name="switchToTextMode">

<!-- environment: lstlisting start embedded generator -->
</p>
<!-- environment block purpose: [[ environment=lstlisting ]] -->
<lstlisting>
<pre>
  integer :: x,y,z
!$OMP parallel
!$OMP single


!$OMP task
  x = f()
!$OMP end task


!$OMP task
  y = g()
!$OMP end task


!$OMP task
  z = h()
!$OMP end task


  print *,"sum=",x+y+z
!$OMP end single
!$OMP end parallel
</pre>
</lstlisting>
<!-- environment: lstlisting end embedded generator -->
</multicols>
<!-- environment: multicols end embedded generator -->
<p name="switchToTextMode">

<!-- environment: answer start embedded generator -->
</p>
<!-- environment block purpose: [[ environment=answer ]] -->
<answer>


</answer>
<!-- environment: answer end embedded generator -->
<p name="switchToTextMode">

<h3><a id="Scheduling">30.2.8</a> Scheduling</h3>
<p name=crumbs>
crumb trail:  > <a href="ompreview.html">ompreview</a> > <a href="ompreview.html#Reviewquestions">Review questions</a> > <a href="ompreview.html#Scheduling">Scheduling</a>
</p>
</p>

<p name="switchToTextMode">
Compare these two fragments. Do they compute the same result? What can you say about their efficiency?
<!-- environment: multicols start embedded generator -->
</p>
<!-- environment block purpose: [[ environment=multicols ]] -->
<multicols>

<p name="multicols">
<!-- TranslatingLineGenerator multicols ['multicols'] -->
<!-- environment: lstlisting start embedded generator -->
</p>
<!-- environment block purpose: [[ environment=lstlisting ]] -->
<lstlisting>
<pre>
#pragma omp parallel
#pragma omp single
  {
    for (i=0; i&lt;N; i++) {
    #pragma omp task
      x[i] = f(i)
    }
    #pragma omp taskwait
  }
</pre>
</lstlisting>
<!-- environment: lstlisting end embedded generator -->
<p name="switchToTextMode">

<!-- environment: lstlisting start embedded generator -->
</p>
<!-- environment block purpose: [[ environment=lstlisting ]] -->
<lstlisting>
<pre>
#pragma omp parallel
#pragma omp for schedule(dynamic)
  {
    for (i=0; i&lt;N; i++) {
      x[i] = f(i)
    }
  }
</pre>
</lstlisting>
<!-- environment: lstlisting end embedded generator -->
</multicols>
<!-- environment: multicols end embedded generator -->
<p name="switchToTextMode">

How would you make the second loop more efficient?
Can you do something similar for the first loop?
</p>

</div>
<a href="index.html">Back to Table of Contents</a>
