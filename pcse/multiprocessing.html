<html>
<head>
<link href="ihpsc.css" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>

<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>

<script type="text/javascript" async
  src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.4.0/MathJax.js?config=TeX-MML-AM_CHTML">
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {inlineMath: [['$','$']]}
  });
  MathJax.Hub.Config({
    TeX: { equationNumbers: { autoNumber: "AMS" } }
  });
</script>

<link rel="stylesheet"
      href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/styles/default.min.css">
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>
</head>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src=https://ccrs.cac.cornell.edu:8443/client.0.2.js></script>
<script id="script">
class Example {
  constructor(buttonID, editorID, outputID, sourceFile, fileName, commandStr) {
    this.buttonID = buttonID;
    this.editorID = editorID;
    this.outputID = outputID;
    this.sourceFile = sourceFile;
    this.fileName = fileName;
    this.commandStr = commandStr;
  }
    
  async display(results, object) {
    if (results.stdout.length > 0)
      document.getElementById(object.outputID).textContent = results.stdout;
    else
      document.getElementById(object.outputID).textContent = results.stderr;
  }

  async initialize() {
    this.editor = await MonacoEditorFileSource.create(this.editorID);
    this.editor.setTextFromFile(this.sourceFile);
    this.job = await Job.create(JobType.MPI);
    this.command = new CommandWithFiles(this.job, this.commandStr);
    this.command.addFileSource(this.editor, this.fileName);
    this.trigger = new ButtonTrigger(this.command, this.display, this.buttonID, this);
    document.getElementById(this.buttonID).disabled = false;
  }
}
</script>
<style></style>

<div class="container">
  <div class="row">
    <div class="col-12">
      <div class="pagehead">
        <h1>Python multiprocessing</h1>
        <h5>Experimental html version of downloadable textbook, see http://www.tacc.utexas.edu/~eijkhout/istc/istc.html</h5>
      </div>
    </div>
  </div>
  <div>


\[
\newcommand\inv{^{-1}}\newcommand\invt{^{-t}}
\newcommand\bbP{\mathbb{P}}
\newcommand\bbR{\mathbb{R}}
\newcommand\defined{
  \mathrel{\lower 5pt \hbox{${\equiv\atop\mathrm{\scriptstyle D}}$}}}
\]


43.1 : <a href="multiprocessing.html#Softwareandhardware">Software and hardware</a><br>
43.2 : <a href="multiprocessing.html#Process">Process</a><br>
43.2.1 : <a href="multiprocessing.html#Arguments">Arguments</a><br>
43.2.2 : <a href="multiprocessing.html#Processdetails">Process details</a><br>
43.3 : <a href="multiprocessing.html#Poolsandmapping">Pools and mapping</a><br>
43.4 : <a href="multiprocessing.html#Shareddata">Shared data</a><br>
43.4.1 : <a href="multiprocessing.html#Pipes">Pipes</a><br>
43.4.2 : <a href="multiprocessing.html#Queues">Queues</a><br>
<a href="index.html">Back to Table of Contents</a>
<h1>43 Python multiprocessing</h1>
<!-- TranslatingLineGenerator file ['file'] -->
</p>

<p name="switchToTextMode">

Python has a 
<i>multiprocessing</i>
 toolbox.
This is a parallel processing library that relies on subprocesses,
rather than threads.
</p>

<h2><a id="Softwareandhardware">43.1</a> Software and hardware</h2>
<p name=crumbs>
crumb trail:  > <a href="multiprocessing.html">multiprocessing</a> > <a href="multiprocessing.html#Softwareandhardware">Software and hardware</a>
</p>
<p name="switchToTextMode">

<div class="card">
  <div class="card-header" id="headingOne">
    <h5 class="mb-0">
      <button class="btn btn-link" data-toggle="collapse" data-target="#pycpycount" aria-expanded="false" aria-controls="pycpycount">
        Python Code: pycpycount
      </button>
    </h5>
  </div>
  <div id="pycpycount" class="collapse">
  <pre>
// pool.py
nprocs = mp.cpu_count()
print(f"I detect {nprocs} cores")
</pre>
</div>
</div>
</p>

<h2><a id="Process">43.2</a> Process</h2>
<p name=crumbs>
crumb trail:  > <a href="multiprocessing.html">multiprocessing</a> > <a href="multiprocessing.html#Process">Process</a>
</p>
<p name="switchToTextMode">

A process is an object that will execute a python function:
<div class="card">
  <div class="card-header" id="headingOne">
    <h5 class="mb-0">
      <button class="btn btn-link" data-toggle="collapse" data-target="#pyproccreate" aria-expanded="false" aria-controls="pyproccreate">
        Python Code: pyproccreate
      </button>
    </h5>
  </div>
  <div id="pyproccreate" class="collapse">
  <pre>
// quicksort.py
import multiprocessing as mp
import random
import os

def quicksort( numbers ) :
    if len(numbers)==1:
        return numbers
    else:
        median = numbers[0]
        left  = [ i for i in numbers if i&lt;median ]
        right = [ i for i in numbers if i&gt;=median ]
        with mp.Pool(2) as pool:
            [sortleft,sortright] = pool.map( quicksort,[left,right] )
        return sortleft.append( sortright )

if __name__ == '__main__':
    numbers = [ random.randint(1,50) for i in range(32) ]
    process = mp.Process(target=quicksort,args=[numbers])
    process.start()
    process.join()
</pre>
</div>
</div>
</p>

<p name="switchToTextMode">
Creating a process does not start it:
for that use the 
<tt>start</tt>
 function.
Execution of the process is not guaranteed until you call the 
<tt>join</tt>

function on it:
<div class="card">
  <div class="card-header" id="headingOne">
    <h5 class="mb-0">
      <button class="btn btn-link" data-toggle="collapse" data-target="#pyprocstartjoin" aria-expanded="false" aria-controls="pyprocstartjoin">
        Python Code: pyprocstartjoin
      </button>
    </h5>
  </div>
  <div id="pyprocstartjoin" class="collapse">
  <pre>
if __name__ == '__main__':
    for p in processes:
        p.start()
    for p in processes:
        p.join()
</pre>
</div>
</div>
</p>

<p name="switchToTextMode">
By making the start and join calls less regular than
in a loop like this,
arbitrarily complicated code can be produced.
</p>

<h3><a id="Arguments">43.2.1</a> Arguments</h3>
<p name=crumbs>
crumb trail:  > <a href="multiprocessing.html">multiprocessing</a> > <a href="multiprocessing.html#Process">Process</a> > <a href="multiprocessing.html#Arguments">Arguments</a>
</p>
<p name="switchToTextMode">

Arguments can be passed to the function of the process
with the 
<tt>args</tt>
 keyword.
This accepts a list (or tuple) of arguments,
leading to a somewhat strange syntax for a single argument:
<!-- environment: lstlisting start embedded generator -->
</p>
<!-- environment block purpose: [[ environment=lstlisting ]] -->
<lstlisting>
<pre>
proc = Process(target=print_func, args=(name,))
</pre>
</lstlisting>
<!-- environment: lstlisting end embedded generator -->
<p name="switchToTextMode">

<h3><a id="Processdetails">43.2.2</a> Process details</h3>
<p name=crumbs>
crumb trail:  > <a href="multiprocessing.html">multiprocessing</a> > <a href="multiprocessing.html#Process">Process</a> > <a href="multiprocessing.html#Processdetails">Process details</a>
</p>
</p>

<p name="switchToTextMode">
Note the test on 
<tt>__main__</tt>
:
the processes started read the current file in order to execute
the function specified.
Without this clause, the import would first execute more process start calls,
before getting to the function execution.
</p>

<p name="switchToTextMode">
Processes have a name that you can retrieve as
 <tt>current_process().name</tt> .
The default is 
<tt>Process-5</tt>
 and such,
but you can specify custom names:
<!-- environment: lstlisting start embedded generator -->
</p>
<!-- environment block purpose: [[ environment=lstlisting ]] -->
<lstlisting>
<pre>
Process(name="Your name here")
</pre>
</lstlisting>
<!-- environment: lstlisting end embedded generator -->
<p name="switchToTextMode">
The target function of a process can get hold of that process
with the   <tt>current_process</tt>  function.
</p>

Of course you can also query  <tt>os.getpid()</tt> 
<p name="switchToTextMode">
but that does not offer any further possibilities.
</p>

<div class="card">
  <div class="card-header" id="headingOne">
    <h5 class="mb-0">
      <button class="btn btn-link" data-toggle="collapse" data-target="#pyprocpid" aria-expanded="false" aria-controls="pyprocpid">
        Python Code: pyprocpid
      </button>
    </h5>
  </div>
  <div id="pyprocpid" class="collapse">
  <pre>
def say_name(iproc):
    print(f"Process {os.getpid()} has name: {mp.current_process().name}")
if __name__ == '__main__':
    processes = [ mp.Process(target=say_name,name=f"proc{iproc}",args=[iproc])
                  for iproc in range(6) ]
</pre>
</div>
</div>
<p name="switchToTextMode">

<h2><a id="Poolsandmapping">43.3</a> Pools and mapping</h2>
<p name=crumbs>
crumb trail:  > <a href="multiprocessing.html">multiprocessing</a> > <a href="multiprocessing.html#Poolsandmapping">Pools and mapping</a>
</p>
</p>

<p name="switchToTextMode">
Often you want a number of processes to do apply to a number of arguments,
for instance in a 
<i>parameter sweep</i>
.
For this, create a 
<tt>Pool</tt>
 object,
and apply the 
<tt>map</tt>
 method to it:
<div class="card">
  <div class="card-header" id="headingOne">
    <h5 class="mb-0">
      <button class="btn btn-link" data-toggle="collapse" data-target="#pymulpoolmap" aria-expanded="false" aria-controls="pymulpoolmap">
        Python Code: pymulpoolmap
      </button>
    </h5>
  </div>
  <div id="pymulpoolmap" class="collapse">
  <pre>
pool = mp.Pool( nprocs )
results = pool.map( print_value,range(1,2*nprocs) )
</pre>
</div>
</div>
</p>

<p name="switchToTextMode">
Note that this is also the easiest way to get return values from a process,
which is not directly possible with a 
<tt>Process</tt>
 object.
Other approaches are using a shared object,
or an object in a 
<tt>Queue</tt>
 or 
<tt>Pipe</tt>
 object; see below.
</p>

<h2><a id="Shareddata">43.4</a> Shared data</h2>
<p name=crumbs>
crumb trail:  > <a href="multiprocessing.html">multiprocessing</a> > <a href="multiprocessing.html#Shareddata">Shared data</a>
</p>
<p name="switchToTextMode">

The best way to deal with shared data is to create
a 
<tt>Value</tt>
 or 
<tt>Array</tt>
 object,
which come equipped with a lock for safe updating.
</p>

<div class="card">
  <div class="card-header" id="headingOne">
    <h5 class="mb-0">
      <button class="btn btn-link" data-toggle="collapse" data-target="#pypivalue" aria-expanded="false" aria-controls="pypivalue">
        Python Code: pypivalue
      </button>
    </h5>
  </div>
  <div id="pypivalue" class="collapse">
  <pre>
pi = mp.Value('d')
pi.value = 0
</pre>
</div>
</div>
<p name="switchToTextMode">

For instance, one could stochastically calculate&nbsp;$\pi$
by
<!-- environment: enumerate start embedded generator -->
</p>
<!-- environment block purpose: [[ environment=enumerate ]] -->
<enumerate>
<ol>
<!-- TranslatingLineGenerator enumerate ['enumerate'] -->
<li>
generating random points in&nbsp;$[0,1)^2$, and
<li>
recording how many fall in the unit circle, after which
<li>
$\pi$ is $4\times$ the ratio between points in the circle
  and the total number of points.
</ol>
</enumerate>
<!-- environment: enumerate end embedded generator -->
<p name="switchToTextMode">

<div class="card">
  <div class="card-header" id="headingOne">
    <h5 class="mb-0">
      <button class="btn btn-link" data-toggle="collapse" data-target="#pypicompute" aria-expanded="false" aria-controls="pypicompute">
        Python Code: pypicompute
      </button>
    </h5>
  </div>
  <div id="pypicompute" class="collapse">
  <pre>
// pi.py
def calc_pi1(pi,n):
    for i in range(n):
        x = random.random()
        y = random.random()
        with pi.get_lock():
            if x*x+y*y&lt;1:
                pi.value += 1.
</pre>
</div>
</div>
</p>

<!-- environment: exercise start embedded generator -->
<!-- environment block purpose: [[ environment=exercise ]] -->
<exercise>
<b>Exercise</b>
<p name="exercise">
<!-- TranslatingLineGenerator exercise ['exercise'] -->
  Do you see a way to improve the speed of this calculation?
</p name="exercise">
</exercise>
<!-- environment: exercise end embedded generator -->
<!-- environment: answer start embedded generator -->
<!-- environment block purpose: [[ environment=answer ]] -->
<answer>


</answer>
<!-- environment: answer end embedded generator -->
<p name="switchToTextMode">

<h3><a id="Pipes">43.4.1</a> Pipes</h3>
<p name=crumbs>
crumb trail:  > <a href="multiprocessing.html">multiprocessing</a> > <a href="multiprocessing.html#Shareddata">Shared data</a> > <a href="multiprocessing.html#Pipes">Pipes</a>
</p>
</p>

<p name="switchToTextMode">
A 
<i>pipe</i>
, object type 
<tt>Pipe</tt>
,
corresponds to what used to be called a 
<i>channel</i>
in older parallel programming systems:
a&nbsp;
<span title="acronym" ><i>FIFO</i></span>
 object into which one process can place items,
and from which another process can take them.
However, a pipe is not associated with any particular pair:
creating the pipe gives the entrace and exit from the pipe
</p>

<div class="card">
  <div class="card-header" id="headingOne">
    <h5 class="mb-0">
      <button class="btn btn-link" data-toggle="collapse" data-target="#pypipecreate" aria-expanded="false" aria-controls="pypipecreate">
        Python Code: pypipecreate
      </button>
    </h5>
  </div>
  <div id="pypipecreate" class="collapse">
  <pre>
q_entrance,q_exit = mp.Pipe()
</pre>
</div>
</div>
<p name="switchToTextMode">

And they can be passed to any process
</p>

<div class="card">
  <div class="card-header" id="headingOne">
    <h5 class="mb-0">
      <button class="btn btn-link" data-toggle="collapse" data-target="#pypipepass" aria-expanded="false" aria-controls="pypipepass">
        Python Code: pypipepass
      </button>
    </h5>
  </div>
  <div id="pypipepass" class="collapse">
  <pre>
producer1 = mp.Process(target=add_to_pipe,args=([1,q_entrance]))
producer2 = mp.Process(target=add_to_pipe,args=([2,q_entrance]))
printer = mp.Process(target=print_from_pipe,args=(q_exit,))
</pre>
</div>
</div>
<p name="switchToTextMode">

which can then can put and get items,
using the 
<tt>send</tt>
 and 
<tt>recv</tt>
 commands.
</p>

<div class="card">
  <div class="card-header" id="headingOne">
    <h5 class="mb-0">
      <button class="btn btn-link" data-toggle="collapse" data-target="#pypipesend" aria-expanded="false" aria-controls="pypipesend">
        Python Code: pypipesend
      </button>
    </h5>
  </div>
  <div id="pypipesend" class="collapse">
  <pre>
// pipemulti.py
def add_to_pipe(v,q):
    for i in range(10):
        print(f"put {v}")
        q.send(v)
        time.sleep(1)
    q.send("END")
</pre>
</div>
</div>
<div class="card">
  <div class="card-header" id="headingOne">
    <h5 class="mb-0">
      <button class="btn btn-link" data-toggle="collapse" data-target="#pypiperecv" aria-expanded="false" aria-controls="pypiperecv">
        Python Code: pypiperecv
      </button>
    </h5>
  </div>
  <div id="pypiperecv" class="collapse">
  <pre>
def print_from_pipe(q):
    ends = 0
    while True:
        v = q.recv()
        print(f"Got: {v}")
        if v=="END":
            ends += 1
        if ends==2:
            break
    print("pipe is empty")
</pre>
</div>
</div>
<p name="switchToTextMode">

<h3><a id="Queues">43.4.2</a> Queues</h3>
<p name=crumbs>
crumb trail:  > <a href="multiprocessing.html">multiprocessing</a> > <a href="multiprocessing.html#Shareddata">Shared data</a> > <a href="multiprocessing.html#Queues">Queues</a>
</p>
</div>
<a href="index.html">Back to Table of Contents</a>
